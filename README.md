<h1> <img src="https://doc.traefik.io/traefik/assets/img/traefikproxy-vertical-logo-color.svg" alt="Traefik Logo" height="80px" align="center" />  Local Proxy for Docker Containers </h1>

This repository provides a docker-compose stack that creates a Traefik Reverse Proxy and a Step-CA Certificate Authority. The Traefik Reverse Proxy is configured to use the Step-CA Certificate Authority to generate certificates for the `localtest.me` domain.

The Traefik Reverse Proxy is by default configured to connect over **HTTP**, but can easily be configured to use the certificates generated by the Step-CA Certificate Authority to provide TLS for a secure connection over **HTTPS**.

This allows you to easily add containers to the proxy and access them securely at:

`https://<desired-address>.localtest.me/`.

___

## Setup for HTTP Connection

1. Clone this repository locally.

    ```sh
    git clone https://github.com/design-group/traefik-proxy.git traefik-proxy && cd traefik-proxy
    ```

2. Pull any changes to the docker image and start the container.
      
    On Mac:
    
	```sh
    docker compose pull && docker compose up -d
    ```
    
	On WSL
    
	```sh
    docker-compose pull && docker-compose up -d
    ```
___

## Setup for HTTPS Connection

1. Clone this repository locally.

    ```sh
    git clone https://github.com/design-group/traefik-proxy.git traefik-proxy && cd traefik-proxy
    ```
2. Create the `certs` directory for the certificates generated by the Step-CA Certificate Authority.

	```sh
	mkdir certs
	```
3. To allow for the HTTPS redirect, go to the `docker-compose.yml` and uncomment line 19:

	```sh
 	TRAEFIK_ENTRYPOINTS_WEB_HTTP_MIDDLEWARES: redirect-to-https@file
  	```

4. Pull any changes to the docker image and start the container.
      
    On Mac:
    
	```sh
    docker compose pull && docker compose up -d
    ```
    
	On WSL
    
	```sh
    docker-compose pull && docker-compose up -d
    ```

5. Generate the certificates for the `localtest.me` domain
   
	```sh
	./generate-certs.sh
	```

6. Trust the root ca certificate generated by the script based on your OS.

	- For Windows: https://learn.microsoft.com/en-us/skype-sdk/sdn/articles/installing-the-trusted-root-certificate
	- For MacOS: https://support.apple.com/guide/keychain-access/add-certificates-to-a-keychain-kyca2431/mac
	- For Linux: https://www.techrepublic.com/article/how-to-install-ca-certificates-in-ubuntu-server/
___

## Usage

To add an Ignition Gateway or other container to the proxy, add the following labels and environment variables to the `docker-compose.traefik.yml` container:

```yaml
labels:
  traefik.enable: "true"
  traefik.hostname: <desired-address>
environment:
  GATEWAY_PUBLIC_ADDRESS: <desired-address>
networks:
  - default
  - proxy
```

The traefik proxy is configured to use the `proxy` network, so we need to add the following networks to the `docker-compose.traefik.yml` file:

```yaml
networks:
  default:
  proxy:
    external: true
    name: proxy
```

After adding the labels and environment variables, restart the container. Once the container restarts, it should be accessible at `http(s)://<desired-address>.localtest.me/`.

___

## Projects with pre-existing docker-compose.yml files

If the project already has a `docker-compose.yml` file, you can add a file named `docker-compose.traefik.yml` to the project. This file will be used to add the labels and environment variables to the container. In order to get your local environment to use this file, add the following to the `.env` file:

```sh
COMPOSE_PATH_SEPARATOR=:
COMPOSE_FILE=docker-compose.yml:docker-compose.traefik.yml
```

Then, add the labels and environment variables to the `docker-compose.traefik.yml` file. For example, here is the pre-existing `docker-compose.yml` file for the basic [Ignition Gateway:](https://github.com/design-group/ignition-architecture-template)

```yaml
services:
  gateway:
    image: bwdesigngroup/ignition-docker:latest
    ports:
      - 8088
    volumes:
      - ./ignition-data:/workdir
      - ./backups/gateway.gwbk:/restore.gwbk
    environment:
      - SYMLINK_GITIGNORE=false
      - SYMLINK_LOGBACK=false
    command: >
      -r /restore.gwbk
```

Here is the `docker-compose.traefik.yml` file for the Ignition Gateway:

```yaml
services:
  gateway:
    labels:
      traefik.enable: "true"
      traefik.hostname: <desired-address>
    environment:
      GATEWAY_PUBLIC_ADDRESS: <desired-address>
    networks:
      - default
      - proxy

networks:
  default:
  proxy:
    external: true
    name: proxy
```

After adding the labels and environment variables, re-up the container. 

```sh
docker-compose up -d
```

Once the container restarts, it should be accessible at `http(s)://<desired-address>.localtest.me/`.

We dont necessarily _need_ to create the `docker-compose.traefik.yml` file to add the labels and environment variables. We could also add the labels and environment variables to the `docker-compose.yml` file directly. However, this would require that every developer working on this project has the same Traefik Reverse Proxy setup on their local machine. By using the `docker-compose.traefik.yml` file, we can keep the Traefik Reverse Proxy setup in this repository and not have to worry about every developer having the same setup.

---

## Enabling TLS for a secure connection over TCP

If you want to enable TLS for a secure connection over TCP, add the following labels to the project's `docker-compose.traefik.yml` container:

```yaml
traefik.tcp.routers.<router-name>.tls: "true"
traefik.tcp.routers.<router-name>.rule: "HostSNI(`<desired-address>.localtest.me`)"
traefik.tcp.routers.<router-name>.service: "<router-name>"
traefik.tcp.services.<router-name>.loadbalancer.server.port: "<port>"
```

For example, to enable TLS for a secure connection over TCP for a Neo4J Graph Database, add the following labels to the project's `docker-compose.traefik.yml` container:

```yaml
traefik.tcp.routers.neo4j.tls: "true"
traefik.tcp.routers.neo4j.rule: "HostSNI(`neo4j.localtest.me`)"
traefik.tcp.routers.neo4j.service: "neo4j"
traefik.tcp.services.neo4j.loadbalancer.server.port: "7687"
```
